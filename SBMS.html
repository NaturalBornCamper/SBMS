<!DOCTYPE html>
<html>
<head>
    <!--


    -->
    <title>ElectroDacus</title>
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>
    <!--<meta http-equiv='refresh' content='3'>-->
    <link rel="stylesheet" href="SBMS.css"/>
    <link rel="stylesheet" href="marco.css"/>
    <link rel="icon" type="image/png" href="favicon.png"/>
    <style media='screen' type='text/css'></style>
    <script language="JavaScript" type="application/javascript" src="jquery-3.3.1.min.js"></script>
    <script language="JavaScript" type="application/javascript" src="all.js"></script>
</head>
<body>
<!--<img class="image" src="http://i.stack.imgur.com/pC1Tv.jpg" alt="" width="120" height="120">-->


<div id="useless">
    <div4 id='mo0'>PV1 & PV2</div4>
    <div4 id='mo2' style='left:240px;'>Battery</div4>
    <div4 id='mo1' style='left:480px;'>Load</div4>
    <div2 style='display: none;' id='id'></div2>
</div>

<div id="container">
    <div id="leftPanel">
        <div class="test2">
            <span class="section-title">Info</span>
            <div id="first">
                <div class="infoBar">
                    <span id="infoBarTitle1" class="infoBarTitle"></span>
                    <span id="infoBarValue1" class="infoBarValue"></span>
                </div>
                <div class="infoBar">
                    <span id="infoBarTitle2" class="infoBarTitle"></span>
                    <span id="infoBarValue2" class="infoBarValue"></span>
                </div>
                <div class="infoBar">
                    <span id="infoBarTitle3" class="infoBarTitle"></span>
                    <span id="infoBarValue3" class="infoBarValue"></span>
                </div>
                <div class="infoBar">
                    <span id="infoBarTitle4" class="infoBarTitle"></span>
                    <span id="infoBarValue4" class="infoBarValue"></span>
                </div>
                <div class="infoBar">
                    <span id="infoBarTitle5" class="infoBarTitle"></span>
                    <span id="infoBarValue5" class="infoBarValue"></span>
                </div>
                <div class="infoBar">
                    <span id="infoBarTitle6" class="infoBarTitle"></span>
                    <span id="infoBarValue6" class="infoBarValue"></span>
                </div>
                <div class="infoBar">
                    <span id="infoBarTitle7" class="infoBarTitle"></span>
                    <span id="infoBarValue7" class="infoBarValue"></span>
                </div>
                <div2 style='left:5px;top:92px;color:#a99;line-height: 25px;' id='d12'></div2>
            </div>
        </div>
        <div class="test2">
            <span class="section-title">Status</span>
            <div id="second">
                <!--<meter id='bat' style='height: 40px; width: 220px; top: 9px;' min='0' low='20' max='100'></meter>-->
                <div id='batt-container'>
                    <div id="batt-gloss"></div>
                    <div id="batt-fill"></div>
                </div>
                <meter style='height: 20px; left: 221px; top:23px; width: 5px;' min='2' max='8' value='0'></meter>
                <div2 style='color:#030;font-size:200%;top:25px;left:90px;text-shadow: -2px -2px 2px #efc;'
                      id='SOC'></div2>

                <div id="status-leds">
                    <div id="led0">PV1 & PV2
                        <div class="led led-yellow"></div>
                    </div>
                    <div id="led2">BATTERY
                        <div class="led led-yellow"></div>
                    </div>
                    <div id="led1">LOAD
                        <div class="led led-yellow"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="test2">
            <span class="section-title">Cells</span>
            <div id="third">
                <div class="largeBar">
                    <div2 style='left:20px; color:#d00;' id='d2'></div2>
                    <div2 style='left:115px; color: #00a9da;' id='d3'></div2>
                    <div2 style='left:165px;color:#888;' id='d4'></div2>
                    <div2 style='left:200px;' id='mt1'></div2>
                </div>
            </div>
        </div>

    </div>

    <div id="rightPanel">
        <div id="date-time" class="test3" style="height: 145px;">
            <time id="date"></time>
            <time id="time"></time>
            <div class="button-container">
                <button onclick="dload('sbms.txt', localStorage['sbms']);">SAVE LOG</button>
                <button onclick="localStorage.removeItem('sbms');localStorage['sbms'] ='';">CLEAR LOG</button>
            </div>
        </div>
        <div id="details" class="test3" style="height: 145px;">
            <div3>
                <div2 style='color:#00a9da;top:22px;' id='d6'></div2>
                <div2 id='d7'></div2>
                <div2 id='d8'></div2>
                <div2 id='d9'></div2>
                <div2 id='d10'></div2>
                <div5 style='width: 600px;top:0px;height:22px;' id='d11'></div5>
            </div3>
        </div>

        <div class="test3">
            <div class="graph-panel">
                <div class="fan">
                    <img id="fan0-0" src="fan.png"/>
                </div>
                <div class="legend">
                    <span class="laser laser-yellow"></span>
                    <br>PV1<br>
                    <span id="avg0-0"></span>
                </div>
                <br>
                <div class="fan">
                    <img id="fan0-1" src="fan.png"/>
                </div>
                <div class="legend">
                    <span class="laser laser-cyan"></span>
                    <br>PV2<br>
                    <span id="avg0-1"></span>
                </div>
            </div>
            <div3>
                <!--<div style='background: #fb9;width: 720px;height:25px;'></div>-->
                <div12h id='g0'></div12h>
                <div1h id='g1'></div1h>
                <div1m id='g2'></div1m>
                <div id='ch0' style='width: 360px;height: 135px;'></div>
                <div class="graph-info first"><span id="graph-info-0-0"></span></div>
                <div class="graph-info second"><span id="graph-info-0-1"></span></div>
                <div class="graph-info third"><span id="graph-info-0-2"></span></div>
                <span class="hours12">12h</span>
                <span class="hour1">1h</span>
                <span class="min1">1m</span>
            </div3>
        </div>

        <div class="test3">
            <div class="graph-panel">
                <div class="fan">
                    <img id="fan3-0" src="fan.png"/>
                </div>
                <div class="legend">
                    <span class="laser laser-green"></span>
                    <br>Batp<br>
                    <span id="avg3-0"></span>
                </div>
                <br>
                <div class="fan">
                    <img id="fan3-1" src="fan.png"/>
                </div>
                <div class="legend">
                    <span class="laser laser-red"></span>
                    <br>Batn<br>
                    <span id="avg3-1"></span>
                </div>
            </div>
            <div3>
                <!--<div style='background: #fb9;width: 720px;height:25px;'></div>-->
                <div12h id='g3'></div12h>
                <div1h id='g4'></div1h>
                <div1m id='g5'></div1m>
                <div id='ch1' style='width: 360px;height: 135px;'></div>
                <div class="graph-info first"><span id="graph-info-3-0"></span></div>
                <div class="graph-info second"><span id="graph-info-3-1"></span></div>
                <div class="graph-info third"><span id="graph-info-3-2"></span></div>
                <span class="hours12">12h</span>
                <span class="hour1">1h</span>
                <span class="min1">1m</span>
            </div3>
        </div>

        <div class="test3">
            <div class="graph-panel">
                <div class="fan">
                    <img id="fan6-0" src="fan.png"/>
                </div>
                <div class="legend">
                    <span class="laser laser-blue"></span>
                    <br>Load<br>
                    <span id="avg6-0"></span>
                </div>
                <br>
                <div class="fan">
                    <img id="fan6-1" src="fan.png"/>
                </div>
                <div class="legend">
                    <span class="laser laser-magenta"></span>
                    <br>ExLd<br>
                    <span id="avg6-1"></span>
                </div>
            </div>
            <div3>
                <!--<div style='background: #fb9;width: 720px;height:25px;'></div>-->
                <div12h id='g6'></div12h>
                <div1h id='g7'></div1h>
                <div1m id='g8'></div1m>
                <div id='ch2' style='width: 360px;height: 135px;'></div>
                <div class="graph-info first"><span id="graph-info-6-0"></span></div>
                <div class="graph-info second"><span id="graph-info-6-1"></span></div>
                <div class="graph-info third"><span id="graph-info-6-2"></span></div>
                <span class="hours12">12h</span>
                <span class="hour1">1h</span>
                <span class="min1">1m</span>
            </div3>
        </div>
    </div>
</div>

<script>
    let searchParams = new URLSearchParams(window.location.search);
    // searchParams.has('sent');
    let interval = parseInt(searchParams.get('interval'));

    var DATA_INTERVAL_OK = isNaN(interval) ? 2000 : interval;
    var DATA_INTERVAL_ERROR = 10000;
    var LOCAL_DEBUG = true;
    var counter = 1;
    var ledsStatus = [1, 1, 1];
    var FAN_MAX_SPEED = 0.5;
    var FAN_MIN_SPEED = 1.5;
    var FAN_DELTA = FAN_MIN_SPEED - FAN_MAX_SPEED;
    var averages = [];
    averages[0] = [-1, -1];
    averages[3] = [-1, -1];
    averages[6] = [-1, -1];

    function reset() {
        $('#d2, #d3, #d4, #d6, #d7, #d8, #d9, #d10, #d11, #d12, #mt1, #g0, #g1, #g2, #g3, #g4, #g5, #g6, #g7, #g8, #ch0, #ch1, #ch2').empty();
    }

    function displayDateTime() {
        var date = new Date();
        var n = date.toDateString();
        var time = date.toLocaleTimeString();
        $('#date').html(n);
        $('#time').html(time);
    }

    function getHslColor(value) {
        value = value / 100.0;
        //value from 0 to 1
        var hue = (value * 120).toString(10);
        return ['linear-gradient(hsl(', hue, ',90%,80%), hsl(', hue, ',90%,50%), hsl(', hue, ',90%,50%), hsl(', hue, ',90%,30%))'].join("");
        // return ["hsl(", hue, ",100%,50%)"].join("");
    }

    function setFanRotation(fanId1, fanId2) {
        var selector = "#fan" + fanId1 + "-" + fanId2;
        $("#avg" + fanId1 + "-" + fanId2).html(averages[fanId1][fanId2] + "%");

        // If average value is 0, set random rotation
        if (averages[fanId1][fanId2] <= 0) {
            $(selector).css('transform', 'rotate(' + Math.random() * 120 + 'deg)');
            $(selector).css('-webkit-animation', 'none').css('-moz-animation', 'none').css('animation', 'none');
        }
        else {
            var css = "spin " + (((100 - averages[fanId1][fanId2]) / 100 * FAN_DELTA) + FAN_MAX_SPEED) + "s linear infinite";
            $(selector).css('-webkit-animation', css).css('-moz-animation', css).css('animation', css);
        }
    }

    function parseData() {
        reset();
        sessionStorage['PV1'] = PV1;
        sessionStorage['PV2'] = PV2;
        sessionStorage['Batp'] = Btp;
        sessionStorage['Batn'] = Btn;
        sessionStorage['Ld'] = Ld;
        sessionStorage['ELd'] = ELd;

        localStorage['sbmsb'] = sbms;
        localStorage['xsbms'] = xsbms;
        localStorage['gsbms'] = gsbms;
        localStorage['eA'] = eA;
        localStorage['eW'] = eW;
        localStorage['cap'] = s1[0];
        localStorage['WA'] = s1[1];
        localStorage['model'] = s1[2];
        localStorage['sbms2'] = JSON.stringify(s2);
        localStorage['sbms'] = localStorage['sbms'] + sbms + '\n';

        all();
    }

    function startDataFetchTimer(miliseconds) {
        console.log(miliseconds);
        setTimeout(getData, miliseconds);
    }

    function getData() {
        var dataUrl = LOCAL_DEBUG ? "data" + counter + ".js" : "http://naturalborncamper.com/sandbox/SBMS/data" + counter + ".js";
        console.log(dataUrl);

        if (LOCAL_DEBUG) {
            $('#dataScript').off('ready load').remove();

            bob = document.body.appendChild(document.createElement('script'));
            bob.id = 'dataScript';
            $('#dataScript').on('load', function () {
                console.log('load');
                parseData();
                startDataFetchTimer(DATA_INTERVAL_OK);
                (counter < 5) ? ++counter : counter = 1;
            });
            bob.src = dataUrl;
        } else {
            $.getScript(dataUrl)
                .done(function (script, textStatus) {
                    parseData();
                    startDataFetchTimer(DATA_INTERVAL_OK);
                    console.log(textStatus);
                })
                .fail(function (jqxhr, settings, exception) {
                    startDataFetchTimer(DATA_INTERVAL_ERROR);
                    console.log("Triggered ajaxError handler.");
                })
                .always(function () {
                    (counter < 5) ? ++counter : counter = 1;
                });
        }
    }
</script>


<script id='smain2'>
    all();

    function dload(n, t) {
        var pom = document.createElement('a');
        pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(t));
        pom.setAttribute('download', n);
        if (document.createEvent) {
            var event = document.createEvent('MouseEvents');
            event.initEvent('click', true, true);
            pom.dispatchEvent(event);
        }
        else {
            pom.click();
        }
    }

    //http://192.168.4.1/
</script>

<script id="dataScript" type="text/javascript"></script>
<!--<script type="text/javascript" src="http://192.168.4.1/"></script>-->

<script>
    $(function () {
        startDataFetchTimer(0);
        displayDateTime();
        setInterval(displayDateTime, 1000);
    })
</script>
</body>
</html>



























